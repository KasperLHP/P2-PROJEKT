<!doctype html>
<html>
<head>
    <title>Flight Ticket Booking</title>
	<link rel="stylesheet" type="text/css" href="./css/style.css">
	<link href="//fonts.googleapis.com/css?family=Open+Sans:400,300italic,300,400italic,600,600italic,700,700italic,800,800italic' rel='stylesheet' type='text/css">
	<link href="//fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css">
	<meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
	<script type="application/x-javascript"> addEventListener("load", function() { setTimeout(hideURLbar, 0); }, false); function hideURLbar(){ window.scrollTo(0,1); } </script>
</head>
<body>
    <h1>
		<div class="img-box">
		<img src="../images/FlightCheckerLogo.png" alt="FlightChecker" id="FClogo" />
		</div>
	</h1>
    <div class="main-agileinfo">
		<div class="sap_tabs">			
			<div id="horizontalTab">
				<ul class="resp-tabs-list">
                    <li class="resp-tab-item"><span>Round trip</span></li>
					<li class="resp-tab-item"><span>One way</span></li>
                    <li class="resp-tab-item"><span>Overview of jobs</span></li>
                </ul>	
				<div class="clearfix"></div>	
				<div class="resp-tabs-container">
                <!-- See graphs -->
                <div class="tab-1 resp-tab-content JobOverview"></div>
                    <table hidden border="1" id = "dataTabel">
                        <tr>
                            <th>Scrape Date</th>
                            <th>Total Price</th>
                            <th>Departure</th>
                            <th>Return</th>
                        </tr>
                    </table>
                    <form id="graf" method="POST" autocomplete="off">
                        <h1 id="LabelForFileName">Route  </h1>
                            <h1 id = "fileName"> </h1>
                        <h1 id="LabelForDeparture">Departure  </h1>
                            <h1 id = "DepartureField"> </h1>
                        <h1 id="LabelForReturn">Return  </h1>
                            <h1 id = "ReturnField"> </h1>
                        <h1 id="LabelForPrice">Lowest recorded price  </h1>
                            <h1 id = "PriceField"> </h1>
                            
                        <div id="showchart"></div>
                    </form>
                </div>						
            </div>
        </div>
    </div>
</body>
</html>


<script>
const mongoose = require('mongoose');
var User = require('./user-models');

// Tabel  
function insertTd(td, dom){
    var node = document.createElement("td");
    var text = document.createTextNode(td);
    node.appendChild(text);
    dom.appendChild(node);
}


fetch("/scrapedata/"+location.hash.substr(1)).then((response) => {
    return response.json();
}).then((data) => {
    // document.getElementById("fileName").textContent = location.hash.substr(1);
    var dataTabel = document.getElementById("dataTabel");
    for(var flight of data) {
        var tr = document.createElement("tr");
        insertTd(flight.ScrapeDate, tr);
        insertTd(flight.TotalPrice, tr);
        insertTd(flight.Departure, tr);
        insertTd(flight.Return, tr);
        dataTabel.appendChild(tr);
    }

    // GRAF 
    console.log(data);
    var flightPrice = [];
    var flightDates = [];
    for(i = 0; i < data.length; i++){
        var movedElement = parseFloat(data[i].TotalPrice); 
        var movedElement2 = data[i].ScrapeDate.slice(4, 10) + data[i].ScrapeDate.slice(15, 21);
        flightPrice.push(movedElement);
        flightDates.push(movedElement2);
    }

    /* The text info on the page where you see graph/chart */ 
    document.getElementById("fileName").textContent = data[1].Departure;
    document.getElementById("DepartureField").textContent = data[1].DepartureDate + ' @ ' + data[1].DepartureTime;

    if(data[1].Return != undefined || "" || null){
        document.getElementById("ReturnField").textContent = data[1].ReturnDate + ' @ ' + data[1].DepartureTime2;
    }else if(data[1].Return == undefined || "" || null){
        document.getElementById("ReturnField").textContent = "False";
        document.getElementById("ReturnField").style = "color:#fff; font-family: 'Montserrat', sans-serif; font-size: 0.9em; margin-top:-120px; margin-bottom:212px; margin-right: 85px; margin-left: -623px;"
    } 

    var lowestIndex = 0;
    for(i = 0; i < flightPrice.length; i++){ 
        var bestPrice = Math.min.apply(null, flightPrice);
        var lowestPrice = bestPrice + ' ' + data[i].Currency;
        if(flightPrice[i] < flightPrice[lowestIndex]){
            lowestIndex = i;
        }
    }
    dateOfLowestPrice = flightDates[lowestIndex];
    var PriceAndDate = lowestPrice + ' @ ' + dateOfLowestPrice;
    document.getElementById("PriceField").textContent = PriceAndDate; // + '' + data[i].Currency;

    var chart = document.getElementById('showchart');
    var layout = {
        autosize: false, width: 680, height: 410, left: 50, right: 50,
        margin: {l: 30, r: 50, b: 70, t: 10}, showlegend: false,
        plot_bgcolor:"transparent", paper_bgcolor:"transparent",
        xaxis: {
            gridcolor: "#878787"
        },
        yaxis: {
            gridcolor: "#878787"
        },
        font: {
            color: 'white'
        }
    };

    var config = ({responsive: true}, {displaylogo: false});
    Plotly.plot(chart, [{
        y: flightPrice,
        x: flightDates,
        line: {
            color: "#ede5da"
        }
    }], layout, config);
});

function StringifyDate(date){
    var d = new Date(date),
    month = '' + (d.getMonth() + 1),
    day = '' + d.getDate(),
    year = d.getFullYear();

    if (month.length < 2) month = '0' + month;
    if (day.length < 2) day = '0' + day;

    var DateBefore = [year, month, day].join('-');
    var DateAfter = JSON.stringify(DateBefore);

    return DateAfter;
}
</script> 
